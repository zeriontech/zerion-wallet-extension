import { Provider as ZksProvider } from 'zksync-ethers';
import { createTypedData, serializePaymasterTx } from './createTypedData';

const sample = {
  transaction: {
    from: '0x969F1B5f8b1B9De7157Ee12E96dF3A47130834F9',
    to: '0x6a6394f47dd0baf794808f2749c09bd4ee874e70',
    nonce: '0x0',
    data: '0xa9059cbb0000000000000000000000001b620fae836730584803dd11bca76bc393ba641900000000000000000000000000000000000000000000000000000000000fb770',
    value: '0x0',
    chainId: 543210,
    gasLimit: '0x453f3',
    maxPriorityFeePerGas: '0x0',
    maxFeePerGas: '0x564eba0',
    customData: {
      paymasterParams: {
        paymaster: '0x4667ffb6a24017f977c93da1bd630cf1801343b6',
        paymasterInput:
          '0x8c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000674ebb8700000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc049000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000417312857f0f0598c9dbfb0ef89cf69c81079b09582003ea4ba58ba888a7d8d0e61a845694b710c8405d9c54308e7f2c49031447d4935299e3913789422fa379db1c00000000000000000000000000000000000000000000000000000000000000',
      },
      gasPerPubdata: '0xc350',
    },
  },
  typedData: {
    types: {
      Transaction: [
        { name: 'txType', type: 'uint256' },
        { name: 'from', type: 'uint256' },
        { name: 'to', type: 'uint256' },
        { name: 'gasLimit', type: 'uint256' },
        { name: 'gasPerPubdataByteLimit', type: 'uint256' },
        { name: 'maxFeePerGas', type: 'uint256' },
        { name: 'maxPriorityFeePerGas', type: 'uint256' },
        { name: 'paymaster', type: 'uint256' },
        { name: 'nonce', type: 'uint256' },
        { name: 'value', type: 'uint256' },
        { name: 'data', type: 'bytes' },
        { name: 'factoryDeps', type: 'bytes32[]' },
        { name: 'paymasterInput', type: 'bytes' },
      ],
      EIP712Domain: [
        { name: 'name', type: 'string' },
        { name: 'version', type: 'string' },
        { name: 'chainId', type: 'uint256' },
      ],
    },
    domain: { name: 'zkSync', version: '2', chainId: '543210' },
    primaryType: 'Transaction',
    message: {
      txType: 113,
      from: '0x969F1B5f8b1B9De7157Ee12E96dF3A47130834F9',
      to: '0x6a6394f47dd0baf794808f2749c09bd4ee874e70',
      gasLimit: '0x453f3',
      gasPerPubdataByteLimit: '0xc350',
      maxFeePerGas: '0x564eba0',
      maxPriorityFeePerGas: '0x0',
      paymaster: '0x4667ffb6a24017f977c93da1bd630cf1801343b6',
      nonce: '0x0',
      value: '0x0',
      data: '0xa9059cbb0000000000000000000000001b620fae836730584803dd11bca76bc393ba641900000000000000000000000000000000000000000000000000000000000fb770',
      factoryDeps: [],
      paymasterInput:
        '0x8c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000674ebb8700000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc049000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000417312857f0f0598c9dbfb0ef89cf69c81079b09582003ea4ba58ba888a7d8d0e61a845694b710c8405d9c54308e7f2c49031447d4935299e3913789422fa379db1c00000000000000000000000000000000000000000000000000000000000000',
    },
  },
};

const signatureSample = {
  transaction: {
    from: '0xE093d671dA3D42fBf79BC333692a7A5f794EdDFb',
    to: '0x6a6394f47dd0baf794808f2749c09bd4ee874e70',
    nonce: '0x0',
    data: '0xa9059cbb0000000000000000000000001b620fae836730584803dd11bca76bc393ba641900000000000000000000000000000000000000000000000000000000000fb770',
    value: '0x0',
    chainId: 543210,
    gasLimit: '0x453f3',
    maxPriorityFeePerGas: '0x0',
    maxFeePerGas: '0x564eba0',
    customData: {
      paymasterParams: {
        paymaster: '0x4667ffb6a24017f977c93da1bd630cf1801343b6',
        paymasterInput:
          '0x8c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000674ebb8700000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc049000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000417312857f0f0598c9dbfb0ef89cf69c81079b09582003ea4ba58ba888a7d8d0e61a845694b710c8405d9c54308e7f2c49031447d4935299e3913789422fa379db1c00000000000000000000000000000000000000000000000000000000000000',
      },
      gasPerPubdata: '0xc350',
    },
  },
  typedData: {
    types: {
      Transaction: [
        { name: 'txType', type: 'uint256' },
        { name: 'from', type: 'uint256' },
        { name: 'to', type: 'uint256' },
        { name: 'gasLimit', type: 'uint256' },
        { name: 'gasPerPubdataByteLimit', type: 'uint256' },
        { name: 'maxFeePerGas', type: 'uint256' },
        { name: 'maxPriorityFeePerGas', type: 'uint256' },
        { name: 'paymaster', type: 'uint256' },
        { name: 'nonce', type: 'uint256' },
        { name: 'value', type: 'uint256' },
        { name: 'data', type: 'bytes' },
        { name: 'factoryDeps', type: 'bytes32[]' },
        { name: 'paymasterInput', type: 'bytes' },
      ],
      EIP712Domain: [
        { name: 'name', type: 'string' },
        { name: 'version', type: 'string' },
        { name: 'chainId', type: 'uint256' },
      ],
    },
    domain: { name: 'zkSync', version: '2', chainId: '543210' },
    primaryType: 'Transaction',
    message: {
      txType: 113,
      from: '0xE093d671dA3D42fBf79BC333692a7A5f794EdDFb',
      to: '0x6a6394f47dd0baf794808f2749c09bd4ee874e70',
      gasLimit: '0x453f3',
      gasPerPubdataByteLimit: '0xc350',
      maxFeePerGas: '0x564eba0',
      maxPriorityFeePerGas: '0x0',
      paymaster: '0x4667ffb6a24017f977c93da1bd630cf1801343b6',
      nonce: '0x0',
      value: '0x0',
      data: '0xa9059cbb0000000000000000000000001b620fae836730584803dd11bca76bc393ba641900000000000000000000000000000000000000000000000000000000000fb770',
      factoryDeps: [],
      paymasterInput:
        '0x8c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000674ebb8700000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc049000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000417312857f0f0598c9dbfb0ef89cf69c81079b09582003ea4ba58ba888a7d8d0e61a845694b710c8405d9c54308e7f2c49031447d4935299e3913789422fa379db1c00000000000000000000000000000000000000000000000000000000000000',
    },
  },
  signature:
    '0x3f95712ebab7d433d35532e32282785ada5749f28ed4c8b8a535146b7657452e21d22e79cce97c43709ef8d958865696ea6b1a43edc0cf1e517d3a46e23d63341c',
  rawTransaction:
    '0x71f9020c8080840564eba0830453f3946a6394f47dd0baf794808f2749c09bd4ee874e7080b844a9059cbb0000000000000000000000001b620fae836730584803dd11bca76bc393ba641900000000000000000000000000000000000000000000000000000000000fb770830849ea8080830849ea94e093d671da3d42fbf79bc333692a7a5f794eddfb82c350c0b8413f95712ebab7d433d35532e32282785ada5749f28ed4c8b8a535146b7657452e21d22e79cce97c43709ef8d958865696ea6b1a43edc0cf1e517d3a46e23d63341cf9013c944667ffb6a24017f977c93da1bd630cf1801343b6b901248c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000674ebb8700000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc049000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000417312857f0f0598c9dbfb0ef89cf69c81079b09582003ea4ba58ba888a7d8d0e61a845694b710c8405d9c54308e7f2c49031447d4935299e3913789422fa379db1c00000000000000000000000000000000000000000000000000000000000000',
};

const hashSample = {
  transaction: {
    from: '0x42b9dF65B219B3dD36FF330A4dD8f327A6Ada990',
    to: '0xe4C82643A4F9Fd288322cc6fBd7C48AB068B38D3',
    nonce: '0x131',
    data: '0x83d13e0100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000000ea73e740fb5900000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000006a6394f47dd0baf794808f2749c09bd4ee874e7000000000000000000000000000000000000000000000000000000000000f4a100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042b9df65b219b3dd36ff330a4dd8f327a6ada990000000000000000000000000223425ae212ba304f17812c41f8ff4cef958f365000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003400000000000000000000000006a6394f47dd0baf794808f2749c09bd4ee874e70000000000000000000000000f93ce7c55073ae244f4a5c810924d790c65f742e000000000000000000000000f93ce7c55073ae244f4a5c810924d790c65f742e00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000026424856bc3000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000f4a100000000000000000000000000000000000000000000000000000ea7567640cc800000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b6a6394f47dd0baf794808f2749c09bd4ee874e70000bb8ac98b49576b1c892ba6bfae08fe1bb0d80cf599c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000e4c82643a4f9fd288322cc6fbd7c48ab068b38d30000000000000000000000000000000000000000000000000000ea7567640cc8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006762aa10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000418d3338c99ae3e8c7b1829d4d7c809f6e10c82f8c80460a7c7d7625a37ffd470c3a5b66b7d2841256e2f7f3dd74ad24033a12ba091338fddae4d5f1a87b5a68421c00000000000000000000000000000000000000000000000000000000000000',
    value: '0x0',
    chainId: 543210,
    gasLimit: '0xadb67',
    maxPriorityFeePerGas: '0x0',
    maxFeePerGas: '0x564eba0',
    customData: {
      paymasterParams: {
        paymaster: '0x4667ffb6a24017f977c93da1bd630cf1801343b6',
        paymasterInput:
          '0x8c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000006762904b00000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc04900000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000041d2e4a6406c5912269c60dc5ea30482189acbbd5803ae6c2274b7a66cd44f5ff9013e450735645457cfaa815f1d79d2bf44415518e5c2f2c863c9bc915b3b34f11c00000000000000000000000000000000000000000000000000000000000000',
      },
      gasPerPubdata: '0xc350',
    },
  },
  signature:
    '0x0df60e3118a91952a479c11d7284ec142321a601d4330c8adfe021eec150daa67eba2e972210ae216eb477ec9a764e20d2e18cad24f770493463c1e23d6892dc1c',
  rawTransaction:
    '0x71f9092f82013180840564eba0830adb6794e4c82643a4f9fd288322cc6fbd7c48ab068b38d380b9076483d13e0100000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000000ea73e740fb5900000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000006a00000000000000000000000006a6394f47dd0baf794808f2749c09bd4ee874e7000000000000000000000000000000000000000000000000000000000000f4a100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042b9df65b219b3dd36ff330a4dd8f327a6ada990000000000000000000000000223425ae212ba304f17812c41f8ff4cef958f365000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003400000000000000000000000006a6394f47dd0baf794808f2749c09bd4ee874e70000000000000000000000000f93ce7c55073ae244f4a5c810924d790c65f742e000000000000000000000000f93ce7c55073ae244f4a5c810924d790c65f742e00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000026424856bc3000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000f4a100000000000000000000000000000000000000000000000000000ea7567640cc800000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b6a6394f47dd0baf794808f2749c09bd4ee874e70000bb8ac98b49576b1c892ba6bfae08fe1bb0d80cf599c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000e4c82643a4f9fd288322cc6fbd7c48ab068b38d30000000000000000000000000000000000000000000000000000ea7567640cc8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006762aa10000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000418d3338c99ae3e8c7b1829d4d7c809f6e10c82f8c80460a7c7d7625a37ffd470c3a5b66b7d2841256e2f7f3dd74ad24033a12ba091338fddae4d5f1a87b5a68421c00000000000000000000000000000000000000000000000000000000000000830849ea8080830849ea9442b9df65b219b3dd36ff330a4dd8f327a6ada99082c350c0b8410df60e3118a91952a479c11d7284ec142321a601d4330c8adfe021eec150daa67eba2e972210ae216eb477ec9a764e20d2e18cad24f770493463c1e23d6892dc1cf9013c944667ffb6a24017f977c93da1bd630cf1801343b6b901248c5a3445000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000006762904b00000000000000000000000036615cf349d7f6344891b1e7ca7c72883f5dc04900000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000041d2e4a6406c5912269c60dc5ea30482189acbbd5803ae6c2274b7a66cd44f5ff9013e450735645457cfaa815f1d79d2bf44415518e5c2f2c863c9bc915b3b34f11c00000000000000000000000000000000000000000000000000000000000000',
  expectedHash:
    '0x6ff5e2abb1d8c7ae0f32e9348ece7ed4b5465eeb8683a58e84130ed9617d87ca',
};

describe('Paymaster tx signing', () => {
  test('Typed data is created correctly', () => {
    const typedData = createTypedData(sample.transaction);
    expect(typedData).toEqual(sample.typedData);
  });

  test('Paymaster tx is signed correctly', () => {
    const typedData = createTypedData(signatureSample.transaction);
    expect(typedData).toEqual(signatureSample.typedData);

    const rawTransaction = serializePaymasterTx({
      transaction: signatureSample.transaction,
      signature: signatureSample.signature,
    });

    expect(rawTransaction).toBe(signatureSample.rawTransaction);
  });

  test('Transaction serializes to expected hash', () => {
    const zksProvider = new ZksProvider();
    const rawTransaction = serializePaymasterTx({
      transaction: hashSample.transaction,
      signature: hashSample.signature,
    });

    expect(rawTransaction).toBe(hashSample.rawTransaction);

    const formattedTx = zksProvider.formatter.transaction(rawTransaction);
    expect(formattedTx.hash).toBe(hashSample.expectedHash);
  });
});
